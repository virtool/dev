apiVersion: v1
kind: ConfigMap
metadata:
  name: mongo-init-script
data:
  setup-mongo.sh: |
    #!/bin/bash
    set -e

    echo "Initializing MongoDB replica set..."

    # Wait for MongoDB to be ready
    until mongosh --quiet --eval "db.adminCommand('ping')" >/dev/null 2>&1; do
      sleep 1
    done

    # Initialize replica set
    mongosh --quiet --eval "
    try {
      rs.initiate({
        _id: 'virtool',
        members: [
          { _id: 0, host: 'mongo-0.mongo.default.svc.cluster.local:27017' }
        ]
      });
      print('Replica set initialized successfully');
    } catch (e) {
      if (e.code === 23) {
        print('Replica set already initialized');
      } else {
        throw e;
      }
    }
    "

    # Wait for replica set to be ready
    echo "Waiting for replica set to be ready..."
    until mongosh --quiet --eval "rs.isMaster().ismaster" | grep -q true; do
      sleep 1
    done

    # Create virtool user
    echo "Creating virtool user..."
    mongosh virtool --quiet --eval "
    try {
      db.createUser({
        user: 'virtool',
        pwd: 'virtool',
        roles: [ { role: 'dbOwner', db: 'virtool' } ]
      });
      print('Virtool user created successfully');
    } catch (e) {
      if (e.code === 51003) {
        print('Virtool user already exists');
      } else {
        throw e;
      }
    }
    "

    echo "MongoDB replica set setup complete!"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongo
spec:
  serviceName: "mongo"
  replicas: 1
  selector:
    matchLabels:
      app: mongo
  template:
    metadata:
      labels:
        app: mongo
    spec:
      containers:
        - name: mongo
          image: mongo:8
          command: ["mongod", "--replSet", "virtool", "--bind_ip_all"]
          ports:
            - containerPort: 27017
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            exec:
              command:
                - mongosh
                - --quiet
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - mongosh
                - --quiet
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - name: data
              mountPath: /data/db
            - name: init-script
              mountPath: /scripts
          lifecycle:
            postStart:
              exec:
                command: ["/bin/bash", "/scripts/setup-mongo.sh"]
      volumes:
        - name: init-script
          configMap:
            name: mongo-init-script
            defaultMode: 0755
        - name: data
          persistentVolumeClaim:
            claimName: pvc-mongo
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-mongo
spec:
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-mongo
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  hostPath:
    path: /db/mongo
---
apiVersion: v1
kind: Service
metadata:
  name: mongo
spec:
  selector:
    app: mongo
  ports:
    - protocol: TCP
      port: 27017
      targetPort: 27017
  clusterIP: None
